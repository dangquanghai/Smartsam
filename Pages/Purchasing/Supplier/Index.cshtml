@page
@model SmartSam.Pages.Purchasing.Supplier.IndexModel
@{
    ViewData["Title"] = "Supplier List";
}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-3">
                <div class="card card-info">
                    <div class="card-header p-2">
                        <h3 class="card-title"><i class="fas fa-search"></i> Search</h3>
                    </div>

                    <div class="card-body">
                        @if (!string.IsNullOrWhiteSpace(Model.Message))
                        {
                            <div class="alert alert-info py-2">@Model.Message</div>
                        }

                        <form method="get">
                            <div class="form-group mb-2">
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" id="viewCurrent" name="ViewMode" value="current" @(Model.ViewMode == "current" ? "checked" : "")>
                                    <label class="custom-control-label" for="viewCurrent">Current List</label>
                                </div>
                                <div class="custom-control custom-radio mt-1">
                                    <input class="custom-control-input" type="radio" id="viewByYear" name="ViewMode" value="byyear" @(Model.ViewMode == "byyear" ? "checked" : "")>
                                    <label class="custom-control-label" for="viewByYear">By Year</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Year</label>
                                <input class="form-control year-input" asp-for="Year" type="number" min="2000" max="2100" />
                            </div>

                            <div class="form-group">
                                <label>Department</label>
                                <select asp-for="DeptId" asp-items="Model.Departments" class="form-control"></select>
                            </div>

                            <div class="form-group">
                                <label>Business</label>
                                <input asp-for="Business" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Supplier Code</label>
                                <input asp-for="SupplierCode" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Contact Person</label>
                                <input asp-for="Contact" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Supplier Name</label>
                                <input asp-for="SupplierName" class="form-control" />
                            </div>

                            <div class="form-group">
                                <label>Status</label>
                                <select asp-for="StatusId" asp-items="Model.Statuses" class="form-control"></select>
                            </div>

                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input asp-for="IsNew" class="custom-control-input" />
                                    <label asp-for="IsNew" class="custom-control-label">New</label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block mb-2">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-block" onclick="window.print()">Print List</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-9 col-lg-9">
                <div class="card card-primary">
                    <div class="card-header p-2 d-flex align-items-center">
                        <h3 class="card-title">Suppliers</h3>
                        <span class="badge badge-light ml-2 supplier-record-badge" id="total-records-badge">@Model.Rows.Count records</span>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive supplier-table-wrap">
                            <table class="table table-hover table-bordered mb-0 supplier-table text-nowrap">
                                <thead class="thead-light">
                                    <tr>
                                        <th style="width:28px"></th>
                                        <th>Supplier Code</th>
                                        <th>Supplier Name</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                        <th>Mobile</th>
                                        <th>Fax</th>
                                        <th>Contact</th>
                                        <th>Position</th>
                                        <th>Business</th>
                                        <th>Status</th>
                                        <th>Dept</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Rows.Count == 0)
                                    {
                                        <tr><td colspan="12" class="text-center text-muted">No data</td></tr>
                                    }
                                    else
                                    {
                                        foreach (var r in Model.Rows)
                                        {
                                            <tr class="supplier-row" data-supplier-id="@r.SupplierID">
                                                <td class="selector-cell"></td>
                                                <td>@r.SupplierCode</td>
                                                <td>@r.SupplierName</td>
                                                <td>@r.Address</td>
                                                <td>@r.Phone</td>
                                                <td>@r.Mobile</td>
                                                <td>@r.Fax</td>
                                                <td>@r.Contact</td>
                                                <td>@r.Position</td>
                                                <td>@r.Business</td>
                                                <td>@r.SupplierStatusName</td>
                                                <td>@r.DeptCode</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card card-outline card-primary">
                    <div class="card-footer p-2 d-flex flex-wrap align-items-center justify-content-between">
                        <div class="btn-toolbar">
                            <div class="btn-group mr-2 mb-2 mb-md-0 supplier-action-group">
                                <a asp-page="./Detail" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Add</a>
                                <a id="viewSupplierBtn" href="@Url.Page("./Detail")" data-base-url="@Url.Page("./Detail")" class="btn btn-info btn-sm disabled" aria-disabled="true"><i class="fas fa-eye"></i> View</a>
                                <a id="editSupplierBtn" href="@Url.Page("./Detail")" data-base-url="@Url.Page("./Detail")" class="btn btn-warning btn-sm disabled" aria-disabled="true"><i class="fas fa-edit"></i> Edit</a>
                                <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#copyYearModal"><i class="fas fa-copy"></i> Copy</button>
                                <button type="button" class="btn btn-dark btn-sm" disabled>Submit</button>
                            </div>
                            <div class="btn-group mb-2 mb-md-0 supplier-action-group">
                                <a asp-page="./Index" asp-page-handler="ExportCsv"
                                   asp-route-ViewMode="@Model.ViewMode"
                                   asp-route-Year="@Model.Year"
                                   asp-route-DeptId="@Model.DeptId"
                                   asp-route-SupplierCode="@Model.SupplierCode"
                                   asp-route-SupplierName="@Model.SupplierName"
                                   asp-route-Business="@Model.Business"
                                   asp-route-Contact="@Model.Contact"
                                   asp-route-StatusId="@Model.StatusId"
                                   asp-route-IsNew="@Model.IsNew"
                                   class="btn btn-primary btn-sm"><i class="fas fa-file-export"></i> Excel</a>
                                <a href="/Index" class="btn btn-default btn-sm">Close</a>
                            </div>
                        </div>

                        <span class="supplier-total mb-2 mb-md-0">Total Record(s): <strong>@Model.Rows.Count</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="copyYearModal" tabindex="-1" role="dialog" aria-labelledby="copyYearModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="copyYearModalLabel">Copy Supplier List</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="copyYearForm" method="post" asp-page-handler="CopyYear">
                    <div class="form-group mb-2">
                        <label>Copy Year</label>
                        <input id="copyYearInput" asp-for="CopyYear" type="number" min="2000" max="2100" class="form-control" />
                    </div>
                    <div class="custom-control custom-checkbox">
                        <input asp-for="ConfirmCopy" class="custom-control-input" />
                        <label asp-for="ConfirmCopy" class="custom-control-label">Are you sure to copy</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="submit" form="copyYearForm" class="btn btn-warning">Copy</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/Purchasing/Supplier/index.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        (() => {
            const rows = document.querySelectorAll(".supplier-row");
            const viewBtn = document.getElementById("viewSupplierBtn");
            const editBtn = document.getElementById("editSupplierBtn");
            const yearInput = document.querySelector(".year-input");
            const currentList = document.getElementById("viewCurrent");
            const byYear = document.getElementById("viewByYear");
            const copyYearModal = document.getElementById("copyYearModal");
            const copyYearInput = document.getElementById("copyYearInput");

            function setActionButtonState(btn, supplierId) {
                if (!btn) return;
                const baseUrl = btn.getAttribute("data-base-url") || "./Detail";
                if (!supplierId) {
                    btn.classList.add("disabled");
                    btn.setAttribute("aria-disabled", "true");
                    btn.setAttribute("href", baseUrl);
                    return;
                }

                btn.classList.remove("disabled");
                btn.setAttribute("aria-disabled", "false");
                btn.setAttribute("href", `${baseUrl}/${supplierId}`);
            }

            function setActiveRow(row) {
                rows.forEach((item) => item.classList.remove("selected"));
                if (!row) {
                    setActionButtonState(viewBtn, null);
                    setActionButtonState(editBtn, null);
                    return;
                }

                row.classList.add("selected");
                const supplierId = row.getAttribute("data-supplier-id");
                setActionButtonState(viewBtn, supplierId);
                setActionButtonState(editBtn, supplierId);
            }

            function syncYearInputState() {
                if (!yearInput || !currentList || !byYear) return;
                yearInput.disabled = currentList.checked;
                if (!byYear.checked) {
                    yearInput.value = "";
                }
            }

            rows.forEach((row) => {
                row.addEventListener("click", () => setActiveRow(row));
                row.addEventListener("dblclick", () => {
                    const supplierId = row.getAttribute("data-supplier-id");
                    if (supplierId) {
                        window.location.href = `./Detail/${supplierId}`;
                    }
                });
            });

            currentList?.addEventListener("change", syncYearInputState);
            byYear?.addEventListener("change", syncYearInputState);

            syncYearInputState();
            setActionButtonState(viewBtn, null);
            setActionButtonState(editBtn, null);

            if (copyYearModal && copyYearInput) {
                $(copyYearModal).on("shown.bs.modal", function () {
                    if (copyYearInput.value === "0") {
                        copyYearInput.value = "";
                    }
                    copyYearInput.focus();
                });
            }
        })();
    </script>
}
