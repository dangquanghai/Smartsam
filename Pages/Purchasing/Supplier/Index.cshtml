@page
@model SmartSam.Pages.Purchasing.Supplier.IndexModel
@{
    ViewData["Title"] = "Suppliers";
    var currentPage = Model.PageIndex <= 0 ? 1 : Model.PageIndex;
    var totalPages = Model.TotalPages <= 0 ? 1 : Model.TotalPages;
    var pageStart = Model.TotalRecords == 0 ? 0 : ((currentPage - 1) * Model.PageSize) + 1;
    var pageEnd = Model.TotalRecords == 0 ? 0 : Math.Min(currentPage * Model.PageSize, Model.TotalRecords);
    var pagerFrom = Math.Max(1, currentPage - 2);
    var pagerTo = Math.Min(totalPages, currentPage + 2);
    Func<int, string> supplierPageUrl = (page) => Url.Page("./Index", new
    {
        ViewMode = Model.ViewMode,
        Year = Model.Year,
        DeptId = Model.DeptId,
        SupplierCode = Model.SupplierCode,
        SupplierName = Model.SupplierName,
        Business = Model.Business,
        Contact = Model.Contact,
        StatusId = Model.StatusId,
        IsNew = Model.IsNew,
        PageIndex = page,
        PageSize = Model.PageSize
    }) ?? "#";
}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- SEARCH PANEL (LEFT) -->
            <div class="col-md-2">
                <div class="card card-info">
                    <div class="card-header p-2">
                        <h3 class="card-title"><i class="fas fa-search"></i> Search</h3>
                    </div>

                    <div class="card-body">
                        <form method="get" id="supplierSearchForm">
                            <input type="hidden" name="PageIndex" value="1" />
                            <input type="hidden" name="PageSize" value="@Model.PageSize" />
                            <div class="form-group mb-2">
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" id="viewCurrent" name="ViewMode" value="current" @(Model.ViewMode == "current" ? "checked" : "")>
                                    <label class="custom-control-label" for="viewCurrent">Current List</label>
                                </div>
                                <div class="custom-control custom-radio mt-1">
                                    <input class="custom-control-input" type="radio" id="viewByYear" name="ViewMode" value="byyear" @(Model.ViewMode == "byyear" ? "checked" : "")>
                                    <label class="custom-control-label" for="viewByYear">By Year</label>
                                </div>
                            </div>

                            <div class="form-group mb-2 collapse" id="yearGroup">
                                <label class="mb-1">Year</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                    </div>
                                    <input class="form-control year-input" asp-for="Year" type="number" min="2000" max="2100" />
                                </div>
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Department</label>
                                <select asp-for="DeptId" asp-items="Model.Departments" class="form-control form-control-sm"></select>
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Business</label>
                                <input asp-for="Business" class="form-control form-control-sm" />
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Supplier Code</label>
                                <input asp-for="SupplierCode" class="form-control form-control-sm" />
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Contact Person</label>
                                <input asp-for="Contact" class="form-control form-control-sm" />
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Supplier Name</label>
                                <input asp-for="SupplierName" class="form-control form-control-sm" />
                            </div>

                            <div class="form-group mb-2">
                                <label class="mb-1">Status</label>
                                <select asp-for="StatusId" asp-items="Model.Statuses" class="form-control form-control-sm"></select>
                            </div>

                            <div class="form-group mb-3">
                                <div class="custom-control custom-checkbox">
                                    <input asp-for="IsNew" class="custom-control-input" />
                                    <label asp-for="IsNew" class="custom-control-label">New</label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block btn-sm mb-2">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-block btn-sm" onclick="window.print()">
                                <i class="fas fa-print"></i> Print List
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- RESULT + ACTION (RIGHT) -->
            <div class="col-md-10" id="supplierResultPanelContainer">
                <div class="card card-primary">
                    <div class="card-header supplier-table-header">
                        <div class="supplier-table-header-left">
                            <h3 class="card-title">Suppliers</h3>
                            <span class="badge badge-light ml-2 supplier-record-badge" id="total-records-badge">@Model.TotalRecords records</span>
                        </div>
                        <div class="supplier-table-header-right app-paging-white">
                            <small class="supplier-table-paging-info">
                                @if (Model.TotalRecords == 0)
                                {
                                    <text>Showing 0 to 0 of 0 entries</text>
                                }
                                else
                                {
                                    <text>Showing @pageStart to @pageEnd of @Model.TotalRecords entries</text>
                                }
                            </small>
                            <ul class="pagination pagination-sm m-0">
                                <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                                    <a class="page-link supplier-pager-link" href="@(Model.HasPreviousPage ? supplierPageUrl(currentPage - 1) : "#")" tabindex="@(Model.HasPreviousPage ? "0" : "-1")">Prev</a>
                                </li>
                                @for (var p = pagerFrom; p <= pagerTo; p++)
                                {
                                    <li class="page-item @(p == currentPage ? "active" : "")">
                                        <a class="page-link supplier-pager-link" href="@supplierPageUrl(p)">@p</a>
                                    </li>
                                }
                                <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                                    <a class="page-link supplier-pager-link" href="@(Model.HasNextPage ? supplierPageUrl(currentPage + 1) : "#")" tabindex="@(Model.HasNextPage ? "0" : "-1")">Next</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive supplier-table-wrap">
                            <table class="table table-hover table-bordered mb-0 supplier-table text-nowrap" id="supplierTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th style="width:32px"></th>
                                        <th>Supplier Code</th>
                                        <th>Supplier Name</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                        <th>Mobile</th>
                                        <th>Fax</th>
                                        <th>Contact</th>
                                        <th>Position</th>
                                        <th>Business</th>
                                        <th>Status</th>
                                        <th>Dept</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Rows.Count == 0)
                                    {
                                        <tr><td colspan="12" class="text-center text-muted">No data</td></tr>
                                    }
                                    else
                                    {
                                        foreach (var r in Model.Rows)
                                        {
                                            <tr class="supplier-row"
                                                data-supplier-id="@r.SupplierID"
                                                data-detail-url="@Url.Page("/Purchasing/Supplier/Detail", new { id = r.SupplierID, viewMode = Model.ViewMode, year = Model.Year })"
                                                data-status="@r.Status"
                                                data-is-submitted="@(r.Status == 1 ? "1" : "0")"
                                                onclick="window.toggleSupplierRowSelection && window.toggleSupplierRowSelection(event, this)">
                                                <td class="selector-cell"><input type="checkbox" class="supplier-selector" aria-label="Select supplier" onchange="window.syncSupplierSelection && window.syncSupplierSelection()" /></td>
                                                <td>
                                                    <a href="@Url.Page("/Purchasing/Supplier/Detail", new { id = r.SupplierID, viewMode = Model.ViewMode, year = Model.Year })"
                                                       class="text-primary font-weight-600 supplier-open-link"
                                                       onclick="event.stopPropagation();">
                                                        @r.SupplierCode
                                                    </a>
                                                </td>
                                                <td>@r.SupplierName</td>
                                                <td>@r.Address</td>
                                                <td>@r.Phone</td>
                                                <td>@r.Mobile</td>
                                                <td>@r.Fax</td>
                                                <td>@r.Contact</td>
                                                <td>@r.Position</td>
                                                <td>@r.Business</td>
                                                <td>@r.SupplierStatusName</td>
                                                <td>@r.DeptCode</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card card-outline card-primary">
                    <div class="card-footer p-2 text-center">
                        @if (Model.PagePerm.HasPermission(2))
                        {
                            <a id="addSupplierBtn" asp-page="/Purchasing/Supplier/Detail" class="btn btn-success btn-sm mx-1 my-1"><i class="fas fa-plus"></i> Add</a>
                        }
                        @if (Model.PagePerm.HasPermission(5))
                        {
                            <button id="copySupplierBtn" type="button" class="btn btn-secondary btn-sm mx-1 my-1" disabled data-toggle="modal" data-target="#copyYearModal"><i class="fas fa-copy"></i> Copy</button>
                        }
                        @if (Model.PagePerm.HasPermission(4))
                        {
                            <form id="submitSupplierForm" method="post" asp-page-handler="Submit" class="d-inline">
                                <input type="hidden" asp-for="SelectedSupplierId" id="selectedSupplierIdInput" />
                                <input type="hidden" asp-for="SelectedSupplierIdsCsv" id="selectedSupplierIdsCsvInput" />
                                <button id="submitSupplierBtn" type="submit" class="btn btn-dark btn-sm mx-1 my-1" disabled><i class="fas fa-paper-plane"></i> Submit</button>
                            </form>
                        }
                        @if (Model.PagePerm.HasPermission(1))
                        {
                            <a asp-page="./Index" asp-page-handler="ExportCsv"
                               asp-route-ViewMode="@Model.ViewMode"
                               asp-route-Year="@Model.Year"
                               asp-route-DeptId="@Model.DeptId"
                               asp-route-SupplierCode="@Model.SupplierCode"
                               asp-route-SupplierName="@Model.SupplierName"
                               asp-route-Business="@Model.Business"
                               asp-route-Contact="@Model.Contact"
                               asp-route-StatusId="@Model.StatusId"
                               asp-route-IsNew="@Model.IsNew"
                               class="btn btn-primary btn-sm mx-1 my-1"><i class="fas fa-file-export"></i> Excel</a>
                        }
                        <a href="/Index" class="btn btn-default btn-sm mx-1 my-1"><i class="fas fa-times"></i> Close</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(Model.Message))
{
    <div id="supplierIndexFlash" data-message="@Model.Message" data-type="@Model.MessageType" class="d-none"></div>
}

@if (Model.PagePerm.HasPermission(5))
{
    <div class="modal fade" id="copyYearModal" tabindex="-1" role="dialog" aria-labelledby="copyYearModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 460px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="copyYearModalLabel">Copy Supplier List</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body py-3">
                    <form id="copyYearForm" method="post" asp-page-handler="CopyYear">
                        <input type="hidden" asp-for="SelectedSupplierIdsCsv" id="copySelectedSupplierIdsCsvInput" />
                        <div class="form-group mb-3">
                            <div class="d-flex align-items-center">
                                <label class="mb-0 mr-3" style="min-width: 84px;">Copy Year</label>
                                <div>
                                    <input id="copyYearInput" asp-for="CopyYear" type="number" min="2000" max="@(DateTime.Today.Year - 1)" class="form-control form-control-sm" style="width: 110px;" />
                                    <div id="copyYearValidation" class="invalid-feedback d-none">Enter a valid year.</div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="custom-control custom-checkbox mb-2 mb-sm-0 mr-3">
                                <input asp-for="ConfirmCopy" class="custom-control-input" />
                                <label asp-for="ConfirmCopy" class="custom-control-label font-weight-normal">Copy selected suppliers to this year?</label>
                            </div>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-default btn-sm mr-2" data-dismiss="modal">Cancel</button>
                                <button id="copyYearSubmitBtn" type="submit" form="copyYearForm" class="btn btn-warning btn-sm" disabled>Copy</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Styles {
    <link rel="stylesheet" href="~/css/Purchasing/Supplier/index.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        (() => {
            const yearInput = document.querySelector(".year-input");
            const supplierSearchForm = document.getElementById("supplierSearchForm");
            const currentList = document.getElementById("viewCurrent");
            const byYear = document.getElementById("viewByYear");
            const yearGroup = document.getElementById("yearGroup");
            const copyYearModal = document.getElementById("copyYearModal");
            const copyYearInput = document.getElementById("copyYearInput");
            const copyConfirmCheckbox = document.getElementById("ConfirmCopy");
            const copyYearSubmitBtn = document.getElementById("copyYearSubmitBtn");
            const copyYearValidation = document.getElementById("copyYearValidation");
            const flashMessageEl = document.getElementById("supplierIndexFlash");

            function validateCopyYearInput(showError) {
                if (!copyYearInput) return false;

                const raw = (copyYearInput.value || "").trim();
                const min = Number(copyYearInput.getAttribute("min") || "2000");
                const max = Number(copyYearInput.getAttribute("max") || "2099");
                const year = Number(raw);
                const isValid = raw.length > 0
                    && Number.isInteger(year)
                    && raw.length === 4
                    && year >= min
                    && year <= max;

                copyYearInput.classList.toggle("is-invalid", !!showError && !isValid);
                if (copyYearValidation) {
                    if (showError && !isValid) {
                        copyYearValidation.textContent = `Enter a year from ${min} to ${max}.`;
                        copyYearValidation.classList.remove("d-none");
                        copyYearValidation.style.display = "block";
                    } else {
                        copyYearValidation.classList.add("d-none");
                        copyYearValidation.style.display = "";
                    }
                }

                return isValid;
            }

            function syncCopyModalButtonState(showYearError = false) {
                if (!copyYearSubmitBtn || !copyConfirmCheckbox) return;
                const isYearValid = validateCopyYearInput(showYearError);
                copyYearSubmitBtn.disabled = !copyConfirmCheckbox.checked || !isYearValid;
            }

            async function reloadSupplierResultPanel(url) {
                const panel = document.getElementById("supplierResultPanelContainer");
                if (!panel) {
                    window.location.href = url;
                    return;
                }

                try {
                    const response = await fetch(url, {
                        method: "GET",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });
                    if (!response.ok) {
                        window.location.href = url;
                        return;
                    }

                    const html = await response.text();
                    const doc = new DOMParser().parseFromString(html, "text/html");
                    const newPanel = doc.getElementById("supplierResultPanelContainer");
                    if (!newPanel) {
                        window.location.href = url;
                        return;
                    }

                    panel.replaceWith(newPanel);
                    if (window.history?.replaceState) {
                        window.history.replaceState({}, "", url);
                    }
                    if (typeof window.initSupplierResultPanel === "function") {
                        window.initSupplierResultPanel();
                    }
                } catch {
                    window.location.href = url;
                }
            }

            function setActionButtonState(btn, supplierId) {
                if (!btn) return;
                const baseUrl = btn.getAttribute("data-base-url") || '@Url.Page("/Purchasing/Supplier/Detail")';
                if (!supplierId) {
                    btn.classList.add("disabled");
                    btn.setAttribute("aria-disabled", "true");
                    btn.setAttribute("href", baseUrl);
                    return;
                }

                btn.classList.remove("disabled");
                btn.setAttribute("aria-disabled", "false");
                btn.setAttribute("href", `${baseUrl}/${supplierId}`);
            }

            function setUiDisabled(btn, disabled) {
                if (!btn) return;
                if (btn.tagName === "A") {
                    if (disabled) {
                        btn.classList.add("disabled");
                        btn.setAttribute("aria-disabled", "true");
                        btn.dataset.prevTabIndex = btn.getAttribute("tabindex") || "";
                        btn.setAttribute("tabindex", "-1");
                    } else {
                        btn.classList.remove("disabled");
                        btn.setAttribute("aria-disabled", "false");
                        if ((btn.dataset.prevTabIndex || "") === "") btn.removeAttribute("tabindex");
                        else btn.setAttribute("tabindex", btn.dataset.prevTabIndex);
                    }
                    return;
                }

                btn.disabled = disabled;
                btn.setAttribute("aria-disabled", disabled ? "true" : "false");
            }

            function isSubmitted(row) {
                if (!row) return false;
                const submittedFlag = row.getAttribute("data-is-submitted");
                if (submittedFlag === "1") return true;
                return false;
            }

            function setSubmitButtonState(btn, disabled) {
                if (!btn) return;
                btn.disabled = disabled;
                if (disabled) {
                    btn.setAttribute("disabled", "disabled");
                    btn.setAttribute("aria-disabled", "true");
                } else {
                    btn.removeAttribute("disabled");
                    btn.setAttribute("aria-disabled", "false");
                }
            }

            function getSelectedRows(rows) {
                return rows.filter((row) => {
                    const checkbox = row.querySelector(".supplier-selector");
                    return !!checkbox && checkbox.checked;
                });
            }

            window.initSupplierResultPanel = function () {
                const panel = document.getElementById("supplierResultPanelContainer");
                if (!panel) return;

                const rows = Array.from(panel.querySelectorAll(".supplier-row"));
                const submitBtn = panel.querySelector("#submitSupplierBtn");
                const selectedSupplierIdInput = panel.querySelector("#selectedSupplierIdInput");
                const selectedSupplierIdsCsvInput = panel.querySelector("#selectedSupplierIdsCsvInput");
                const copySelectedSupplierIdsCsvInput = document.getElementById("copySelectedSupplierIdsCsvInput");
                const addBtn = panel.querySelector("#addSupplierBtn");
                const copyBtn = panel.querySelector("#copySupplierBtn");
                function syncSelectionState() {
                    const selectedRows = getSelectedRows(rows);
                rows.forEach((row) => row.classList.toggle("selected", selectedRows.includes(row)));

                const count = selectedRows.length;
                const singleRow = count === 1 ? selectedRows[0] : null;
                const singleId = singleRow?.getAttribute("data-supplier-id") || null;
                const selectedIds = selectedRows
                    .map((row) => row.getAttribute("data-supplier-id"))
                    .filter((id) => !!id);

                if (selectedSupplierIdInput) selectedSupplierIdInput.value = singleId || "";
                if (selectedSupplierIdsCsvInput) selectedSupplierIdsCsvInput.value = selectedIds.join(",");
                if (copySelectedSupplierIdsCsvInput) copySelectedSupplierIdsCsvInput.value = selectedIds.join(",");

                const hasAnySelected = count > 0;
                const hasSubmittedSelected = selectedRows.some((row) => isSubmitted(row));
                setSubmitButtonState(submitBtn, !hasAnySelected || hasSubmittedSelected);

                const isMultiSelectMode = count > 1;
                setUiDisabled(addBtn, isMultiSelectMode);
                setUiDisabled(copyBtn, !hasAnySelected);
                }

                window.syncSupplierSelection = syncSelectionState;
                window.toggleSupplierRowSelection = (ev, row) => {
                    if (!row) return;
                    if (ev?.target?.closest?.(".supplier-selector")) {
                        syncSelectionState();
                        return;
                    }

                    const checkbox = row.querySelector(".supplier-selector");
                    if (!checkbox) return;
                    checkbox.checked = !checkbox.checked;
                    syncSelectionState();
                };

                rows.forEach((row) => {
                    row.addEventListener("dblclick", () => {
                        const detailUrl = row.getAttribute("data-detail-url");
                        if (detailUrl) {
                            window.location.href = detailUrl;
                        }
                    });
                });

                panel.querySelectorAll(".supplier-pager-link").forEach((link) => {
                    link.addEventListener("click", (e) => {
                        const href = link.getAttribute("href");
                        if (!href || href === "#" || link.closest(".page-item.disabled")) {
                            e.preventDefault();
                            return;
                        }
                        e.preventDefault();
                        void reloadSupplierResultPanel(href);
                    });
                });

                syncSelectionState();
            };

            function syncYearInputState() {
                if (!yearInput || !currentList || !byYear) return;
                const showYear = byYear.checked;
                yearInput.disabled = !showYear;
                if (yearGroup) {
                    yearGroup.classList.toggle("show", showYear);
                }
                if (!showYear) yearInput.value = "";
            }

            currentList?.addEventListener("change", syncYearInputState);
            byYear?.addEventListener("change", syncYearInputState);

            syncYearInputState();
            window.initSupplierResultPanel();

            if (copyYearModal && copyYearInput) {
                $(copyYearModal).on("shown.bs.modal", function () {
                    if (copyYearInput.value === "0") {
                        copyYearInput.value = "";
                    }
                    if (copyConfirmCheckbox) {
                        copyConfirmCheckbox.checked = false;
                    }
                    if (copyYearInput) {
                        copyYearInput.classList.remove("is-invalid");
                    }
                    if (copyYearValidation) {
                        copyYearValidation.classList.add("d-none");
                        copyYearValidation.style.display = "";
                    }
                    syncCopyModalButtonState(false);
                    copyYearInput.focus();
                });

                $(copyYearModal).on("hidden.bs.modal", function () {
                    if (copyConfirmCheckbox) {
                        copyConfirmCheckbox.checked = false;
                    }
                    if (copyYearInput) {
                        copyYearInput.classList.remove("is-invalid");
                    }
                    if (copyYearValidation) {
                        copyYearValidation.classList.add("d-none");
                        copyYearValidation.style.display = "";
                    }
                    syncCopyModalButtonState(false);
                });
            }

            copyConfirmCheckbox?.addEventListener("change", () => syncCopyModalButtonState(false));
            copyYearInput?.addEventListener("input", () => syncCopyModalButtonState(false));
            copyYearInput?.addEventListener("blur", () => syncCopyModalButtonState(true));
            syncCopyModalButtonState(false);

            if (flashMessageEl && window.jQuery && $.fn.Toasts) {
                const message = flashMessageEl.getAttribute("data-message");
                const type = (flashMessageEl.getAttribute("data-type") || "info").toLowerCase();
                const toastClass = type === "success"
                    ? "bg-success"
                    : type === "warning"
                        ? "bg-warning"
                        : type === "error"
                            ? "bg-danger"
                            : "bg-info";
                const shouldKeepOpen = type === "warning" || type === "error";

                if (message) {
                    $(document).Toasts('create', {
                        class: toastClass,
                        title: 'Supplier',
                        position: 'topRight',
                        autohide: !shouldKeepOpen,
                        delay: shouldKeepOpen ? 0 : 3200,
                        body: message
                    });
                }
            }
        })();
    </script>
}
