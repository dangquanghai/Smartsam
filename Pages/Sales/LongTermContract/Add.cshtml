@page
@model SmartSam.Pages.Sales.LongTermContract.AddModel
@{
    ViewData["Title"] = "Add Long Term Contract";
}

<section class="content">
    <div class="container-fluid">
        <form method="post">
            <div class="row d-flex align-items-stretch">
                <div class="col-md-5">
                    <div class="card card-primary card-outline h-100 mb-0">
                        <div class="card-header p-2">
                            <h3 class="card-title">General Information</h3>
                        </div>
                        <div class="card-body p-2">
                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">ContractNo</label></div>
                                <div class="col-3">
                                    <input type="text" asp-for="Contract.ContractNo" id="ContractNo" class="form-control form-control-sm" readonly>
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">Status</label></div>
                                <div class="col-4">
                                    <select asp-for="Contract.ContractStatus" id="ContractStatus" asp-items="Model.StatusList" class="form-control form-control-sm">
                                        <option value="">-- Status --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">C.Date</label></div>
                                <div class="col-3">
                                    <input type="date" asp-for="Contract.ContractDate" id="ContractDate" class="form-control form-control-sm">
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">Company</label></div>
                                <div class="col-4">
                                    <select asp-for="Contract.CompanyID" id="CompanyId" class="form-control form-control-sm select2-remote">
                                        <option value="">-- Select Company --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">Apartment</label></div>
                                <div class="col-3">
                                    <select asp-for="Contract.ApmtID" id="ApmtId" class="form-control form-control-sm select2-remote">
                                        <option value="">--Apartment--</option>
                                    </select>
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">Representator</label></div>
                                <div class="col-4">
                                    <input type="text" asp-for="Contract.Representator" id="Representator" class="form-control form-control-sm">
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">RentIncVAT</label></div>
                                <div class="col-3">
                                    <input type="number" asp-for="Contract.CurrentRentRateVND" id="CurrentRentRate" class="form-control form-control-sm text-right">
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">Contarct Period</label></div>
                                <div class="col-4">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        </div>
                                        <input type="text" class="form-control form-control-sm" id="contractDuration">
                                        <input type="hidden" asp-for="Contract.ContractFromDate" id="ContractFromDate">
                                        <input type="hidden" asp-for="Contract.ContractToDate" id="ContractToDate">
                                    </div>
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">%VAT</label></div>
                                <div class="col-3">
                                    <input type="number" asp-for="Contract.PerVAT" id="PerVAT" class="form-control form-control-sm text-right">
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">New/Amentment</label></div>
                                <div class="col-4">
                                    <select asp-for="Contract.AmendmentOrNewContract" id="AmendmentOrNewContract" asp-items="Model.NewAmendmentList" class="form-control form-control-sm">
                                        <option value="">--New/Amentment--</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">Exl.VAT</label></div>
                                <div class="col-3">
                                    <input type="number" asp-for="Contract.TotalPriceExcVATVND" id="TotalPriceExcVAT" class="form-control form-control-sm text-right" readonly>
                                </div>
                                <div class="col-3 text-left pl-4 pr-2"><label class="col-form-label-sm mb-0">Elec.Norm</label></div>
                                <div class="col-4">
                                    <input type="number" asp-for="Contract.ElecVND_Amount" id="ElecAmount" class="form-control form-control-sm text-right">
                                </div>
                            </div>

                            <div class="row no-gutters align-items-center mb-2">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mb-0">Receiver By</label></div>
                                <div class="col-3">
                                    <select asp-for="Contract.ReceivedBy" id="ReceivedBy" asp-items="Model.ReceiverList" class="form-control form-control-sm">
                                        <option value="">--Receiver--</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row no-gutters align-items-start mb-0">
                                <div class="col-2 text-left pr-2"><label class="col-form-label-sm mt-1">Remark</label></div>
                                <div class="col-10">
                                    <textarea asp-for="Contract.Remarks" id="Remarks" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer py-2">
                            <div class="float-left">
                                <button type="button" class="btn btn-info btn-sm px-4"><i class="fas fa-history"></i> History</button>
                                <button type="submit" class="btn btn-primary btn-sm px-4"><i class="fas fa-save"></i> Save Contract</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card card-success card-outline h-100 mb-0">
                        <div class="card-header p-2">
                            <h3 class="card-title">Contract Services</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="height: 380px;">
                                <table class="table table-sm table-bordered table-striped m-0" id="tableServices">
                                    <thead class="bg-light sticky-top">
                                        <tr>
                                            <th>Service Name</th>
                                            <th>From Date</th>
                                            <th>To Date</th>
                                            <th>Interval</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer py-2">
                            <button type="button" class="btn btn-success btn-sm px-4"><i class="fas fa-plus"></i> Add Service</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="card card-secondary card-outline">
                        <div class="card-header p-2">
                            <h3 class="card-title">Tenants Information</h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="min-height: 200px;">
                                <table class="table table-sm table-bordered table-hover mb-0" id="tableTenants">
                                    <thead class="bg-gray-light">
                                        <tr>
                                            <th>Full Name</th>
                                            <th>Birthday</th>
                                            <th>Nationality</th>
                                            <th>Passport/ID</th>
                                            <th>Position</th>
                                            <th>Move-in</th>
                                            <th>Exp. Date</th>
                                            <th>Visa No</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer py-2">
                            <button type="button" class="btn btn-primary btn-sm px-4"><i class="fas fa-add"></i>Add From List</button>
                            <button type="button" class="btn btn-primary btn-sm px-4"><i class="fas fa-view"></i>View</button>
                            <button type="button" class="btn btn-primary btn-sm px-4"><i class="fas fa-new"></i>Add New</button>
                            <button type="button" class="btn btn-primary btn-sm px-4"><i class="fas fa-edit"></i>Edit</button>
                            <button type="button" class="btn btn-primary btn-sm px-4"><i class="fas fa-del"></i>Remove</button>
                            <a asp-page="./Index" class="btn btn-default btn-sm float-right">Back to List</a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 1. Khởi tạo Select2 Remote
            if (window.initSelect2) {
                window.initSelect2('#CompanyId', 'CM_Company', 'CompanyID', 'CompanyName');
                window.initSelect2('#ApmtId', 'AM_Apmt', 'ApmtID', 'ApartmentNo');
            }

            // 2. Khởi tạo DateRangePicker
            $('#contractDuration').daterangepicker({
                locale: { format: 'DD/MM/YYYY' },
                autoUpdateInput: false
            }).on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                $('#ContractFromDate').val(picker.startDate.format('YYYY-MM-DD'));
                $('#ContractToDate').val(picker.endDate.format('YYYY-MM-DD'));
            });

            // 3. Logic tự động tính Exl.VAT (Ví dụ)
            $('#CurrentRentRate, #PerVAT').on('change keyup', function () {
                let rent = parseFloat($('#CurrentRentRate').val()) || 0;
                let vat = parseFloat($('#PerVAT').val()) || 0;
                let exclVat = rent / (1 + (vat / 100));
                $('#TotalPriceExcVAT').val(exclVat.toFixed(0));
            });
        });
    </script>
}